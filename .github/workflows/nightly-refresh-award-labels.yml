name: Nightly refresh award_status labels

on:
  schedule:
    # KST 02:00 = UTC 17:00
    - cron: "0 17 * * *"
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run refresh function (auto since, default backfill=6 hours)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c \
            "SELECT * FROM pps_bid.refresh_award_status_labels_auto();"

      - name: Show checkpoint
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c \
            "SELECT job_name, last_run_at, last_status, last_message
             FROM pps_bid.etl_checkpoint
             WHERE job_name IN ('refresh_award_status_labels');"
